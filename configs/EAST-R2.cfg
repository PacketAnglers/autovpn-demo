! Command: show running-config
! device: EAST-R2 (CloudEOS, EOS-4.34.2F-43232954.4342F (engineering build))
!
no aaa root
!
username admin privilege 15 role network-admin secret sha512 $6$UfCRaI6CerAMs1gp$iJHeVGrWKlVDdpDKuj09o9TVyuWKaHHd1iSfXD7YdU0gx9HPxJbs07hl0Ysybu6fvGEMa3vBeOF9wDX9O7S2b/
!
agent KernelFib environment KERNELFIB_PROGRAM_ALL_ECMP='true'
!
management api http-commands
   no shutdown
   !
   vrf MGMT
      no shutdown
!
switchport default mode routed
!
no service interface inactive port-id allocation disabled
!
transceiver qsfp default-mode 4x10G
!
interface defaults
   mtu 9214
!
service routing protocols model multi-agent
!
hostname EAST-R2
!
router adaptive-virtual-topology
   topology role edge gateway vxlan
   !
   policy DEFAULT-AVT-POLICY
      match application-profile default
         avt profile DEFAULT-AVT-PROFILE
   !
   profile DEFAULT-AVT-PROFILE
      path-selection load-balance DEFAULT-LB-POLICY
   !
   vrf A
      avt policy DEFAULT-AVT-POLICY
      avt profile DEFAULT-AVT-PROFILE id 1
   !
   vrf default
      avt policy DEFAULT-AVT-POLICY
      avt profile DEFAULT-AVT-PROFILE id 1
!
router path-selection
   tcp mss ceiling ipv4 ingress
   !
   path-group INET id 1
      ipsec profile IPSEC-PROFILE
      !
      local interface Ethernet2
         stun server-profile EAST-R1-Ethernet2 WEST-R1-Ethernet2
      !
      peer dynamic
      !
      peer static router-ip 10.1.1.103
         name DC1-R2
         ipv4 address 192.1.103.2
      !
      peer static router-ip 10.1.2.103
         name DC2-R2
         ipv4 address 192.2.103.2
   !
   load-balance policy DEFAULT-LB-POLICY
      path-group INET
!
spanning-tree mode none
!
system l1
   unsupported speed action error
   unsupported error-correction action error
!
vrf instance A
!
vrf instance MGMT
!
aaa authorization exec default local
!
ip security
   ike policy IPSEC-IKE-POLICY
      local-id 10.1.2.104
   !
   sa policy IPSEC-SA-POLICY
   !
   profile IPSEC-PROFILE
      ike-policy IPSEC-IKE-POLICY
      sa-policy IPSEC-SA-POLICY
      connection start
      shared-key 7 070E33455D1D18544541
      dpd 10 50 clear
      mode transport
      !
      flow entropy udp
   !
   key controller
      profile IPSEC-PROFILE
!
interface Dps1
   description TEP IP
   ip address 10.1.2.104/32
!
interface Ethernet1
   no switchport
   vrf A
   ip address 22.101.104.104/24
!
interface Ethernet2
   description INTERNET
   no switchport
   ip address 192.2.104.2/30
!
interface Loopback0
   description Globally Unique Address
   ip address 10.0.2.104/32
!
interface Management1
   vrf MGMT
   ip address 172.100.100.108/24
!
interface Vxlan1
   vxlan source-interface Dps1
   vxlan udp-port 4789
   vxlan vrf A vni 51
   vxlan vrf default vni 50
!
ip routing
ip routing vrf A
no ip routing vrf MGMT
!
ip route 0.0.0.0/0 192.2.104.1
ip route vrf MGMT 0.0.0.0/0 172.100.100.1
!
arp aging timeout default 1500
!
router bfd
   interval 1000 min-rx 1000 multiplier 3 default
!
router bgp 64512
   router-id 10.0.2.104
   no bgp default ipv4-unicast
   distance bgp 20 200 200
   neighbor default send-community
   neighbor IPv4-UNDERLAY-PEERS peer group
   neighbor WAN-OVERLAY-PEERS peer group
   neighbor WAN-OVERLAY-PEERS remote-as 64512
   neighbor WAN-OVERLAY-PEERS update-source Dps1
   neighbor WAN-OVERLAY-PEERS maximum-routes 0
   neighbor 10.1.1.103 peer group WAN-OVERLAY-PEERS
   neighbor 10.1.1.103 description DC1-R2.DPS.EVPN
   neighbor 10.1.2.103 peer group WAN-OVERLAY-PEERS
   neighbor 10.1.2.103 description DC2-R2.DPS.EVPN
   !
   address-family evpn
      neighbor WAN-OVERLAY-PEERS activate
      neighbor WAN-OVERLAY-PEERS rcf in AS64512_EVPN_IN()
      neighbor WAN-OVERLAY-PEERS rcf out AS64512_EVPN_OUT()
      neighbor WAN-OVERLAY-PEERS encapsulation path-selection 
   !
   address-family ipv4
      neighbor IPv4-UNDERLAY-PEERS activate
   !
   address-family path-selection
      bgp additional-paths receive
      bgp additional-paths send any
      neighbor WAN-OVERLAY-PEERS activate
   !
   vrf A
      rd 10.0.2.104:51
      route-target import evpn 51:51
      route-target export evpn 51:51
      neighbor 22.101.104.101 remote-as 65002
      neighbor 22.101.104.101 description EAST-AGG
      redistribute connected
      !
      address-family ipv4
         neighbor 22.101.104.101 activate
         redistribute connected
!
router general
   control-functions
      code unit AS64512_EVPN_IN
      function AS64512_EVPN_IN() {
          if HAS_NO_WAN_COMMUNITY() {
              local_preference = 90;
              return true;
          }
          return true;
      }
      EOF
      code unit AS64512_EVPN_OUT
      function AS64512_EVPN_OUT() {
          return true;
      }
      EOF
      code unit HAS_NO_WAN_COMMUNITY
      function HAS_NO_WAN_COMMUNITY() {
          return community has_none { 64512:999 };
      }
      EOF
!
stun
   client
      server-profile EAST-R1-Ethernet2
         ip address 192.2.103.2
      !
      server-profile WEST-R1-Ethernet2
         ip address 192.1.103.2
!
end