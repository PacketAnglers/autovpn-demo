ip routing
!
vrf instance A
!
ip routing vrf A
!
router adaptive-virtual-topology
   topology role edge
   !
   policy DEFAULT-AVT-POLICY
      match application-profile default
         avt profile DEFAULT-AVT-PROFILE
   !
   profile DEFAULT-AVT-PROFILE
      path-selection load-balance DEFAULT-LB-POLICY
   !
   vrf A
      avt policy DEFAULT-AVT-POLICY
      avt profile DEFAULT-AVT-PROFILE id 1
   !
   vrf default
      avt policy DEFAULT-AVT-POLICY
      avt profile DEFAULT-AVT-PROFILE id 1
!
router path-selection
   tcp mss ceiling ipv4 ingress
   !
   path-group INET id 1
      ipsec profile IPSEC-PROFILE
      !
      local interface Ethernet2
         stun server-profile EAST-R1-Ethernet2 WEST-R1-Ethernet2
      !
      peer dynamic
      !
      peer static router-ip 10.1.1.103
         name WEST-R1
         ipv4 address 192.1.103.2
      !
      peer static router-ip 10.1.2.103
         name EAST-R1
         ipv4 address 192.2.103.2
   !
   load-balance policy DEFAULT-LB-POLICY
      path-group INET
!
ip security
   ike policy IPSEC-IKE-POLICY
      local-id 10.1.6.101
   !
   sa policy IPSEC-SA-POLICY
   !
   profile IPSEC-PROFILE
      ike-policy IPSEC-IKE-POLICY
      sa-policy IPSEC-SA-POLICY
      connection start
      shared-key 7 06071D285F5A08485744
      dpd 10 50 clear
      mode transport
      !
      flow entropy udp
   !
   key controller
      profile IPSEC-PROFILE
!
interface Dps1
   ip address 10.1.6.101/32
!
!
interface Loopback0
   ip address 10.0.6.101/32
!
interface Vxlan1
   vxlan source-interface Dps1
   vxlan udp-port 4789
   vxlan vrf A vni 51
   vxlan vrf default vni 50
!
ip route 0.0.0.0/0 192.6.101.1
!
arp aging timeout default 1500
!
router bfd
   interval 1000 min-rx 1000 multiplier 3 default
!
router bgp 64512
   router-id 10.0.6.101
   no bgp default ipv4-unicast
   distance bgp 20 200 200
   neighbor default send-community
   neighbor WAN-OVERLAY-PEERS peer group
   neighbor WAN-OVERLAY-PEERS remote-as 64512
   neighbor WAN-OVERLAY-PEERS update-source Dps1
   neighbor WAN-OVERLAY-PEERS maximum-routes 0
   neighbor 10.1.1.103 peer group WAN-OVERLAY-PEERS
   neighbor 10.1.1.103 description WEST-R1.DPS.EVPN
   neighbor 10.1.2.103 peer group WAN-OVERLAY-PEERS
   neighbor 10.1.2.103 description EAST-R1.DPS.EVPN
   !
   address-family evpn
      neighbor WAN-OVERLAY-PEERS activate
      neighbor WAN-OVERLAY-PEERS rcf in AS64512_EVPN_IN()
      neighbor WAN-OVERLAY-PEERS rcf out AS64512_EVPN_OUT()
      neighbor WAN-OVERLAY-PEERS encapsulation path-selection
   !
   address-family path-selection
      bgp additional-paths receive
      bgp additional-paths send any
      neighbor WAN-OVERLAY-PEERS activate
   !
   vrf A
      rd 10.0.6.101:51
      route-target import evpn 51:51
      route-target export evpn 51:51
      redistribute connected
!
router general
   control-functions
      code unit AS64512_EVPN_IN
      function AS64512_EVPN_IN() {
          if next_hop is 10.1.2.103 or next_hop is 10.1.2.104 {
              local_preference = 150;
              return true;
          }
          return true;
      }
      EOF
      code unit AS64512_EVPN_OUT
      function AS64512_EVPN_OUT() {
          community add { 64512:999 };
          return true;
      }
      EOF
!
stun
   client
      server-profile EAST-R1-Ethernet2
         ip address 192.2.103.2
      !
      server-profile WEST-R1-Ethernet2
         ip address 192.1.103.2
!
end
